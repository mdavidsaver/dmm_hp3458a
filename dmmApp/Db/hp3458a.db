# readout for a single HP 3458a DMM
#
# macros
#  P    - record name prefix
#  PORT - asyn port

record(longout, "$(P)SCAN_") {
    field(DISV, "1") # I disable myself to prevent queues scans
                     # If I'm getting behind, then better to drop scans
    field(SCAN, "1 second")
    field(VAL , "1")
    field(OUT , "$(P)SCAN_.DISA NPP")
    field(FLNK, "$(P)SYNC1_")
    field(TPRO, "$(TPRO=)")
}

# wait for any other DMMs to finish readout
record(longout, "$(P)SYNC1_") {
    field(DTYP, "Process Barrier")
    field(OUT , "@arm$(BARRIER=global)")
    field(FLNK, "$(P)SAMP_")
    field(TPRO, "$(TPRO=)")
}

# Arm for trigger
record(bo, "$(P)SAMP_") {
    field(DTYP, "stream")
    field(OUT , "@hp3458a.proto sample $(PORT)")
    field(FLNK, "$(P)SYNC2_")
    field(TPRO, "$(TPRO=)")
}

# wait for any other DMMs to be armed
record(longout, "$(P)SYNC2_") {
    field(DTYP, "Process Barrier")
    field(OUT , "@sample$(BARRIER=global)")
    field(FLNK, "$(P)I")
    field(TPRO, "$(TPRO=)")
}

# Read sample from input buffer
record(ai, "$(P)I") {
    field(DTYP, "stream")
    field(INP , "@hp3458a.proto readout $(PORT)")
    field(PHAS, "2")
    field(EGU , "A")
    field(PREC, "9")
    field(FLNK, "$(P)SYNC3_")
    field(TPRO, "$(TPRO=)")
}

# wait for readouts to complete
record(longout, "$(P)SYNC3_") {
    field(DTYP, "Process Barrier")
    field(OUT , "@done$(BARRIER=global)")
    field(FLNK, "$(P)DONE_")
    field(TPRO, "$(TPRO=)")
}

record(longout, "$(P)DONE_") {
    field(VAL , "0") # done.  Allow next scan
    field(OUT , "$(P)SCAN_")
}
