# readout for a single HP 3458a DMM
#
# macros
#  P    - record name prefix
#  PORT - asyn port

record(bo, "$(P)RUN") {
    field(ZNAM, "Pause")
    field(ONAM, "Sample")
    field(FLNK, "$(P)RUN_")
    field(TPRO, "$(TPRO=)")
}

record(fanout, "$(P)RUN_") {
    field(LNK1, "$(P)DIS_")
    field(LNK2, "$(P)ENA_")
    field(TPRO, "$(TPRO=)")
}

record(bo, "$(P)ENA_") {
    field(SDIS, "$(P)RUN")
    field(DISV, "0") # disable while Paused
    field(DTYP, "stream")
    field(OUT , "@hp3458a.proto setup $(PORT)")
    field(TPRO, "$(TPRO=)")
}

record(bo, "$(P)DIS_") {
    field(SDIS, "$(P)RUN")
    field(DISV, "1") # disable while Sampling
    field(DTYP, "stream")
    field(OUT , "@hp3458a.proto detach $(PORT)")
    field(TPRO, "$(TPRO=)")
}

# Arm for trigger
record(bo, "$(P)SAMP_") {
    field(SDIS, "$(P)RUN NPP")
    field(DISV, "0") # disable while Paused
    field(DTYP, "stream")
    field(OUT , "@hp3458a.proto sample $(PORT)")
    field(SCAN, "1 second")
    field(FLNK, "$(P)SYNC_")
    field(TPRO, "$(TPRO=)")
}

# wait for any other DMMs to be armed
record(longout, "$(P)SYNC_") {
    field(DTYP, "Process Barrier")
    field(OUT , "@$(BARRIER=global)")
    field(FLNK, "$(P)I")
    field(TPRO, "$(TPRO=)")
}

# Read sample from input buffer
record(ai, "$(P)I") {
    field(DTYP, "stream")
    field(INP , "@hp3458a.proto readout $(PORT)")
    field(PHAS, "2")
    field(EGU , "A")
    field(PREC, "9")
    field(FLNK, "$(P)CNT")
    field(TPRO, "$(TPRO=)")
}

record(calc, "$(P)CNT") {
    field(CALC, "VAL+1")
}

record(calc, "$(P)RATE") {
    field(DESC, "Update rate")
    field(INPA, "$(P)CNT NPP")
    field(CALC, "C:=A-B;B:=A;C/10")
    field(SCAN, "10 second")
    field(EGU , "Hz")
    field(PREC, "1")
}
